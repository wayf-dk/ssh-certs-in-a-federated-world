<section>
<H2>DeiC SSH Certificate Authority [PILOT]</h2>
<p>The DEiC SSH Certificate Authority creates SSH certificates based on a federated login.
<p>The public key for the certificate authority is:
<p><code id=certpublickey>ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIJoDNr0ec0yRaDdr7NhQtJkaNNPF+QQkeINOFYlPaT0b</code> <button class=copy data-target=certpublickey></button>
</section>
<section>
<p>Hello <em><?= $_SESSION['principals'][0]; ?></em>
</section>
<section>

<p>For this POC the CA will use the public key <em>$HOME/.ssh/id_ed25519.pub</em> and create a SSH certificate <em>$HOME/.ssh/id_ed25519-cert.pub</em>. The SSH certificate will be valid for 24 hours.

<p>The command below is already copied to your clipboard. Execute it in a shell to upload the public key and download the SSH certificate.
<p><code id=curl></code> <button class=copy data-target=curl></button>
<p>For your first login copy the command below and excecute it in a shell:
<p><code id=sshcmd></code> <button class=copy data-target=sshcmd></button>
<p>For subsequent logins copy the command below and excecute it in a shell:
<p><code id=sshcmd2></code> <button class=copy data-target=sshcmd2></button>
<p>You can use <code id=sshkeygen>ssh-keygen -Lf .ssh/&lt;privat n√∏gle navn&gt;-cert.pub</code> <button class=copy data-target=sshkeygen></button> to see if the contents of the
certificate - e.g. if it is expired.
<pre id=cert></pre>
</section>

<script>

const buttons = document.querySelectorAll('button.copy')
buttons.forEach(b => b.addEventListener('click', e => {
    const cp = document.querySelector(`#${e.target.dataset.target}`).innerText
    navigator.clipboard.writeText(cp).then()
})
)

setCurl()

function setCurl() {
    const key = 'id_ed25519'
    let curl = 'curl -sk %u/%t -F pub="<$HOME/.ssh/%p.pub"  -o "$HOME/.ssh/%p-cert.pub"'
    const t = '<?= $sessionId ?>'
    curl = curl.replaceAll('%t', t )
    curl = curl.replaceAll('%p', key)
    const l = window.location
    curl = curl.replaceAll('%u', `${l.protocol}//${l.host}/getc`)
    document.querySelector('#curl').innerText = curl
    const sshkeygen = `ssh-keygen -Lf "$HOME/.ssh/${key}-cert.pub"`
    document.querySelector("#sshkeygen").innerText = sshkeygen
    const sshcmd = `ssh -i "$HOME/.ssh/${key}" nobody@test-arken.test.lan`
    document.querySelector("#sshcmd").innerText = sshcmd
    const sshcmd2 = `ssh -i "$HOME/.ssh/${key}" <?= $_SESSION['principals'][0] ?>@test-arken.test.lan`
    document.querySelector("#sshcmd2").innerText = sshcmd2
    navigator.clipboard.writeText(curl).then()
    const href = `http://127.0.0.1:7780?token=${t}`
    document.querySelector("a#localhost").href = href

    fetch(href)
        .then(response => response.text())
        .then(data => document.querySelector('#cert').innerText = data)
}
</script>
